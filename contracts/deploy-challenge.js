const hre = require("hardhat");
const fs = require("fs");
const path = require("path");

async function main() {
    console.log("Deploying ChallengeArena...");

    const ChallengeArena = await hre.ethers.getContractFactory("ChallengeArena");
    const challenge = await ChallengeArena.deploy();
    await challenge.waitForDeployment();

    const address = await challenge.getAddress();
    console.log(`ChallengeArena deployed to: ${address}`);

    // Update frontend config
    const configPath = path.join(__dirname, "..", "config", "challengeConfig.ts");
    const configContent = `// Auto-generated by deploy-challenge.js
export const CHALLENGE_CONTRACT_ADDRESS = '${address}';

export const CHALLENGE_ABI = [
    "function submitChallenge(uint256 _marketId, bool _isRed, string calldata _title, string calldata _evidence, uint256 _replyToId) external returns (uint256)",
    "function getMarketChallengeCount(uint256 _marketId) external view returns (uint256)",
    "function getMarketChallengeIds(uint256 _marketId, uint256 _offset, uint256 _limit) external view returns (uint256[])",
    "function getChallenge(uint256 _challengeId) external view returns (uint256 id, uint256 marketId, uint8 cType, address author, string title, string evidence, uint256 timestamp, uint256 replyToId)",
    "function challengeCount() view returns (uint256)"
];
`;
    fs.writeFileSync(configPath, configContent);
    console.log(`Config written to ${configPath}`);

    // Verify
    try {
        console.log("Verifying contract...");
        await hre.run("verify:verify", {
            address: address,
            constructorArguments: [],
        });
        console.log("Contract verified!");
    } catch (e) {
        console.log("Verification skipped:", e.message);
    }
}

main().catch((error) => {
    console.error(error);
    process.exitCode = 1;
});
